<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Beschwerdemeldung</title>
  <link rel="shortcut icon" href="http://www.dorsten.de/favicon.ico" type="image/x-icon" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

	<!--link rel="stylesheet/less" href="less/bootstrap.less" type="text/css" /-->
	<!--link rel="stylesheet/less" href="less/responsive.less" type="text/css" /-->
	<!--script src="js/less-1.3.3.min.js"></script-->
	<!--append ‘#!watch’ to the browser URL, then refresh the page. -->
	
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/style.css" rel="stylesheet">

  <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
  <!--[if lt IE 9]>
    <script src="js/html5shiv.js"></script>
  <![endif]-->

  <!-- Fav and touch icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="img/apple-touch-icon-144-precomposed.png">
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="img/apple-touch-icon-114-precomposed.png">
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="img/apple-touch-icon-72-precomposed.png">
  <link rel="apple-touch-icon-precomposed" href="img/apple-touch-icon-57-precomposed.png">
  <link rel="shortcut icon" href="img/favicon.png">
  
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/scripts.js"></script>
	<script type="text/javascript" src="tom.js"></script>
	
	<h4><a href="http://www.dorsten.de/" id="link"><img alt="" src="img/Logo.gif" id="logo">
	 <b style="color: #BDBDBD">www.</b>dorsten<b style="color: #BDBDBD">.de</b></a></h4>
</head>

<body onload="mapping()">
	<script type="text/javascript" src="storage.js"></script>
	<script type="text/javascript">
	function sichern () {
		storage.set("nachricht", document.forms.form.elements.nachricht.value);
		//storage.set("Foto", document.forms.form.elements.foto.value);
		storage.set("schadensort", document.forms.form.elements.schadensort.value);
		storage.set("latitude", document.getElementById("lati").innerHTML);
		storage.set("longitude", document.getElementById("longi").innerHTML);
		location.href = "05kontrolle.html";
	}
	
	function pflichtfelder () {
		var i=0;
		if (document.getElementById("nachricht").value==""){
			document.getElementById("divnachricht").style.backgroundColor="red";
		 }else {
			sichern();
		}
	}
	
	function textCounter(field, countfield, maxlimit) {
			countfield.innerHTML = "Ihre Nachricht* (Noch "+(maxlimit - field.value.length)+" Zeichen)";
	}
	</script>
	<div class="container jumbotron">
		<div class="row clearfix">
			<div class="col-md-12 column">
				<h3>
					Bitte füllen Sie alle gekennzeichneten Felder aus!
				</h3>
				<h4>
					*Pflichtfelder
				</h4>
			</div>
		</div>
		<div class="row clearfix">
			<div class="col-md-6 column">
			<form role="form" method="post" name="form" id="form" action="" onsubmit="pflichtfelder(); return false;">
					<div class="form-group" id="divnachricht">
					
					<label id="zeichen" name="zeichen">Ihre Nachricht* (Noch 128 Zeichen)</label></br>
					<textarea id="nachricht" name="nachricht" placeholder="Ihre Nachricht/ Beschwerde/ Anregung/ Idee eingeben*" cols="35" rows="4" 
					maxlength="128" onKeyDown="textCounter(document.getElementById('nachricht'),document.getElementById('zeichen'),128);" onKeyUp="textCounter(document.getElementById('nachricht'),document.getElementById('zeichen'),128);"></textarea>
					</br> 
					</div>
					<p id="feedback"></p>
			<p id="lati" class="lalo" name="lati">Latitude: </p>
			<p id="longi" class="lalo" name="longi">Longitude: </p>


			<a href="#" class="btn btn-yellow" onclick="init();" type="button">Aktuellen Standort verwenden (GPS)</a>
			</br></br>
			<label>Oder manuell eingeben:</label>
			</br>
					<div class="form-group">
						 <label>Adresse des Schadenortes</label>
						 <p><input class="form-control" id="schadensort" name="schadensort" type="name" value=""></p>
						 <input type="button" value="Adresse auf Karte anzeigen" onclick="coordsByAddress(); aktivieren()"></input>
					</div>
					<div class="form-group">
						<br><label>Foto hochladen</label></br>
							<input id="inputFileToLoad" type="file" onchange="encodeImageFileAsURL();">
							<input id="rmpicture" type="button" value="Foto löschen" style="float: right" onclick="removePicture()" hidden></input>
							<div id="imgTest"></div>
							<script type='text/javascript'>
								function encodeImageFileAsURL(){
									var filesSelected = document.getElementById("inputFileToLoad").files;
									if (filesSelected.length > 0){
										var fileToLoad = filesSelected[0];
										var fileReader = new FileReader();
										fileReader.onload = function(fileLoadedEvent) {
											var srcData = fileLoadedEvent.target.result; // <--- data: base64
											var newImage = document.createElement('img');
											newImage.src = srcData;
											document.getElementById("imgTest").innerHTML = newImage.outerHTML;
											//alert("Converted Base64 version is "+document.getElementById("imgTest").innerHTML);
											storage.set("attachment1", document.getElementById("imgTest").innerHTML);
										}
										fileReader.readAsDataURL(fileToLoad);
									}
									document.getElementById("rmpicture").removeAttribute("hidden");
								}
								
								function removePicture(){
									document.getElementById("imgTest").innerHTML = "";
									document.getElementById("rmpicture").setAttribute("hidden", true);
									document.getElementById("inputFileToLoad").innerHTML = "";
								}
							</script>
					</div>
					<p><input type="submit" id="weiter" class="btn btn-blue" disabled name="submit" style="float:right" value="Bitte geben Sie einen Schadensort an"></input></p>
					<script type="text/javascript">
						function aktivieren(){
							var weiter = document.getElementById("weiter");
							weiter.setAttribute("class", "btn btn-blue");
							weiter.setAttribute("value", "Weiter");
							weiter.removeAttribute("disabled");
						}
					</script>
				</form>
			</div>
			<div class="col-md-6 column mapdiv">
				</br>
				<p><div id="basicMap" class="mapcontainer"></div></p>
				<script type="text/javascript"
				  src="https://maps.googleapis.com/maps/api/js?sensor=false">
				</script>
				<script src="http://openlayers.org/api/OpenLayers.js"></script>
				<script type="text/javascript">		
					var lati = document.getElementById("lati");
					var longi = document.getElementById("longi");
					var markers = new OpenLayers.Layer.Markers( "Markers" );
					//map = new OpenLayers.Map("basicMap", {controls:[new OpenLayers.Control.MousePosition()]});
					function mapping(){
						map = new OpenLayers.Map("basicMap");
						map.addLayer(new OpenLayers.Layer.OSM());
						var lonLat = new OpenLayers.LonLat(6.967222, 51.668889)
									.transform(
										new OpenLayers.Projection("EPSG:4326"), //transform from WGS 1984
										map.getProjectionObject() //to Spherical Mercator Projection
									);
						map.setCenter(lonLat,13);
						
						var click = new OpenLayers.Control.Click();
						map.addControl(click);
						click.activate();				
				    }
				//Set up a click handler
				OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {                
                defaultHandlerOptions: {
                    'single': true,
                    'double': false,
                    'pixelTolerance': 8,
                    'stopSingle': false,
                    'stopDouble': false
                }, initialize: function(options) {
                    this.handlerOptions = OpenLayers.Util.extend(
                        {}, this.defaultHandlerOptions
                    );
                    OpenLayers.Control.prototype.initialize.apply(
                        this, arguments
                    ); 
                    this.handler = new OpenLayers.Handler.Click(
                        this, {
                            'click': this.trigger
                        }, this.handlerOptions
                    );
                }, trigger: function(e) {
                    //A click happened!
                    var lonlat = map.getLonLatFromViewPortPx(e.xy)
                    lonlat.transform(
                      new OpenLayers.Projection("EPSG:900913"), 
                      new OpenLayers.Projection("EPSG:4326")
                    );
                    lati.innerHTML="Latitude: " + lonlat.lat;
					longi.innerHTML="Longitude: " + lonlat.lon;
					addressByCoords(lonlat.lat, lonlat.lon);
					lonLat = new OpenLayers.LonLat(lonlat.lon,lonlat.lat)
							.transform(
								new OpenLayers.Projection("EPSG:4326"), //transform from WGS 1984
								map.getProjectionObject() //to Spherical Mercator Projection
							);
						if (markers) {
							markers.destroy();
							markers = new OpenLayers.Layer.Markers( "Markers" );
						}
						markers.addMarker(new OpenLayers.Marker(lonLat));
						map.addLayer(markers);
						aktivieren();
                }
            });
				
				function init() {
					var mapnik = new OpenLayers.Layer.OSM();
					map.addLayer(mapnik);

					navigator.geolocation.getCurrentPosition(function(position) {
						lati.innerHTML="Latitude: " + position.coords.latitude;
						longi.innerHTML="Longitude: " + position.coords.longitude;
						addressByCoords(position.coords.latitude, position.coords.longitude);
						lonLat = new OpenLayers.LonLat(position.coords.longitude,position.coords.latitude)
							.transform(
								new OpenLayers.Projection("EPSG:4326"), //transform from WGS 1984
								map.getProjectionObject() //to Spherical Mercator Projection
							);
						if (markers) {
							markers.destroy();
							markers = new OpenLayers.Layer.Markers( "Markers" );
						}					
						markers.addMarker(new OpenLayers.Marker(lonLat));
						map.setCenter(lonLat, 16);
						map.addLayer(markers);
						aktivieren();
					});				
				}
				
				//Tried with OpenLayers Geocoder
				/*function getCoordsByAddress() {
					var queryString = document.getElementById("schadensort").value;
					OpenLayers.Request.POST({
						url: "http://www.openrouteservice.org/php/OpenLSLUS_Geocode.php",
						scope: this,
						failure: this.requestFailure,
						success: this.requestSuccess,
						headers: {"Content-Type": "application/x-www-form-urlencoded"},
						data: "FreeFormAdress=" + encodeURIComponent(queryString) + "&MaxResponse=1"
					});
				}
				function requestSuccess(response) {
					var format = new OpenLayers.Format.XLS();
					alert("ok");
					var output = format.read(response.responseXML);
					if (output.responseLists[0]) {
						var geometry = output.responseLists[0].features[0].geometry;
						var foundPosition = new OpenLayers.LonLat(geometry.x, geometry.y).transform(
								new OpenLayers.Projection("EPSG:4326"),
								map.getProjectionObject()
								);
						map.setCenter(foundPosition, 16);
					} else {
						alert("Sorry, no address found");
					}
				}
				function requestFailure(response) {
					alert("An error occurred while communicating with the OpenLS service. Please try again.");
				}*/
				
				function coordsByAddress(){
					var geocoder = new google.maps.Geocoder();
					var address = document.getElementById('schadensort').value;
					  geocoder.geocode( { 'address': address}, function(results, status) {
						if (status == google.maps.GeocoderStatus.OK) {
						  lati.innerHTML = "Latitude: " + results[0].geometry.location.lat();
						  longi.innerHTML = "Longitude: " + results[0].geometry.location.lng();

					lonLat = new OpenLayers.LonLat(results[0].geometry.location.lng(),results[0].geometry.location.lat())
							.transform(
								new OpenLayers.Projection("EPSG:4326"), //transform from WGS 1984
								map.getProjectionObject() //to Spherical Mercator Projection
							);
							map.setCenter(lonLat,16);
						if (markers) {
							markers.destroy();
							markers = new OpenLayers.Layer.Markers( "Markers" );
						}
						markers.addMarker(new OpenLayers.Marker(lonLat));
						map.addLayer(markers);
					} else {
					  alert('Geocode was not successful for the following reason: ' + status);
					}
				  });
				}
				
				//Tried with OpenLayers Reverse Geocoder
				/*function search() {
					var s = document.createElement('script');       
					s.src = 'http://nominatim.openstreetmap.org/reverse?json_callback=cb&format=json&lat=51.56320001&lon=6.66140002&zoom=27&addressdetails=1';
					document.getElementsByTagName('head')[0].appendChild(s);
					alert(s);
				};*/
				
				function addressByCoords(eins, zwei) {
					var geocoder = new google.maps.Geocoder();
				    var latlng = new google.maps.LatLng(eins, zwei);
				    geocoder.geocode({'latLng': latlng}, function(results, status) {
					  if (results[0]) {
						var address = document.getElementById('schadensort');
						address.value = results[0].formatted_address;
					  } 
					});
				}
				
				</script>
			</div>
		</div>
		</br>
	</div>
	<h5 align="center"><a href="http://www.dorsten.de/" id="link">
		<b style="color: #8b8b8b">www.dorsten.de</b></a>
		| <a href="http://www.dorsten.de/Impressum.htm" id="link">
		<b style="color: #8b8b8b">Impressum</b>
		</a>
		</h5>
</body>
</html>
