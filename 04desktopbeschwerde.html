<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ABBA Dorsten</title>
  <link rel="shortcut icon" href="http://www.dorsten.de/favicon.ico" type="image/x-icon" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

	<!--link rel="stylesheet/less" href="less/bootstrap.less" type="text/css" /-->
	<!--link rel="stylesheet/less" href="less/responsive.less" type="text/css" /-->
	<!--script src="js/less-1.3.3.min.js"></script-->
	<!--append ‘#!watch’ to the browser URL, then refresh the page. -->
	
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/style.css" rel="stylesheet">
	<link href="css/dropzone.css" rel="stylesheet">

  <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
  <!--[if lt IE 9]>
    <script src="js/html5shiv.js"></script>
  <![endif]-->

  <!-- Fav and touch icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="img/apple-touch-icon-144-precomposed.png">
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="img/apple-touch-icon-114-precomposed.png">
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="img/apple-touch-icon-72-precomposed.png">
  <link rel="apple-touch-icon-precomposed" href="img/apple-touch-icon-57-precomposed.png">
  <link rel="shortcut icon" href="img/favicon.png">
  
	<script type="text/javascript" src="dropzone.min.js"></script>
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/scripts.js"></script>
	<script type="text/javascript" src="tom.js"></script>
	
	<div class="bl"><h4 id="link"><a href="http://www.dorsten.de/" title="Zur Dorsten-Homepage"><img alt="" src="img/Logo.gif" id="logo"></a>
	<span id="bltext">Aktive Bürger Beteiligungs App</span></h4></div><p></p>
</head>

<body onload="mapping(); deaktivieren('change');">
	<script type="text/javascript" src="storage.js"></script>
	<script type="text/javascript">
	function sichern () {
		localStorage.setItem("nachricht", document.forms.form.elements.nachricht.value);
		//localStorage.setItem("Foto", document.forms.form.elements.foto.value);
		localStorage.setItem("schadensort", document.forms.form.elements.schadensort.value);
		localStorage.setItem("latitude", document.getElementById("lati").innerHTML);
		localStorage.setItem("longitude", document.getElementById("longi").innerHTML);
		document.getElementById("my-awesome-dropzone").submit();
		location.href = "05kontrolle.html";
	}
	
	function pflichtfelder () {
		var i=0;
		if (document.getElementById("nachricht").value==""){
			document.getElementById("nachricht").setAttribute("style","background-Color:#ffccdd");
			document.getElementById("nachricht").focus();
		 }else {
			sichern();
		}
	}
	
	function textCounter(field, countfield, maxlimit) {
			countfield.innerHTML = "Ihre Nachricht* (Noch "+(maxlimit - field.value.length)+" Zeichen)";
	}
	</script>
	<div class="container jumbotron">
		<div class="row clearfix">
			<div class="col-md-12 column">
				<h3>
					Bitte geben Sie eine Nachricht und den Schadensort an.
				</h3>
				<h4>
					*Pflichtfelder
				</h4>
			</div>
		</div>
		<div class="row clearfix">
			<div class="col-md-6 column">
			<form role="form" method="post" name="form" id="form" action="" onsubmit="pflichtfelder(); return false;">
					<div class="form-group" id="divnachricht">
					
					<label id="zeichen" name="zeichen">Ihre Nachricht* (Noch 1024 Zeichen)</label></br>
					<textarea id="nachricht" name="nachricht" placeholder="Ihre Nachricht/ Beschwerde/ Anregung/ Idee eingeben*" cols="35" rows="4" 
					maxlength="1024" onKeyDown="textCounter(document.getElementById('nachricht'),document.getElementById('zeichen'),1024);" onKeyUp="textCounter(document.getElementById('nachricht'),document.getElementById('zeichen'),1024);"></textarea>
					</br> 
					</div>
					<p id="feedback"></p>
			<p id="lati" class="lalo" name="lati" hidden></p>
			<p id="longi" class="lalo" name="longi" hidden></p>


			<a href="#" class="btn btn-sm btn-blue" onclick="leeren();init();gpsCheck();" type="button">Aktuellen Standort verwenden (GPS)</a>
			<label id="gpsfail" hidden><span> Ihr Standort konnte leider nicht bestimmt werden.</span></label>
			</br></br>
			<label>Oder manuell eingeben:</label>
			</br>
					<div class="form-group">
						 <label>Adresse des Schadenortes* (auch durch Karte auswählbar)</label>
						 <p><input class="form-control" id="schadensort" name="schadensort" type="name" onkeydown='deaktivieren("change")' value="" maxlength="128"></p>
						 <input type="button" class="btn btn-sm btn-blue" value="Adresse auf Karte anzeigen" onclick="coordsByAddress();"></input>
					</div>
					
					<script type="text/javascript">
						function aktivieren(){
							var weiter = document.getElementById("weiter");
							weiter.setAttribute("value", "Weiter");
							weiter.removeAttribute("disabled");
						}
						
						function deaktivieren(reason){
							var weiter = document.getElementById("weiter");
							weiter.setAttribute("disabled", true);
							if(reason=="change"){
								weiter.setAttribute("value", "Bitte geben Sie einen Schadensort an.");
							}
							if(reason=="nichtDorsten"){
								weiter.setAttribute("value", "Der angegebene Schadensort ist nicht in Dorsten.");
							}
						}
						
						function submitForms(){
							//document.getElementById("my-awesome-dropzone").submit();
							//document.getElementById("form").submit();
							pflichtfelder(); return false;
							
						}
					</script>
					<p><input type="submit" id="weiter" class="btn btn-blue" disabled name="submit" style="float:right" value="Bitte geben Sie einen Schadensort an"></input></p><br></br></br>
				</form>
				
			</div>
			<div class="col-md-6 column mapdiv">
				</br>
				<p><div id="basicMap" class="mapcontainer"></div></p>
				<script type="text/javascript"
				  src="https://maps.googleapis.com/maps/api/js?sensor=false">
				</script>
				<script src="http://openlayers.org/api/OpenLayers.js"></script>
				<script type="text/javascript">		
					var lati = document.getElementById("lati");
					var longi = document.getElementById("longi");
					var markers = new OpenLayers.Layer.Markers( "Markers" );
					//map = new OpenLayers.Map("basicMap", {controls:[new OpenLayers.Control.MousePosition()]});
					function mapping(){
						map = new OpenLayers.Map("basicMap");
						map.addLayer(new OpenLayers.Layer.OSM());
						var lonLat = new OpenLayers.LonLat(6.967222, 51.668889)
									.transform(
										new OpenLayers.Projection("EPSG:4326"), //transform from WGS 1984
										map.getProjectionObject() //to Spherical Mercator Projection
									);
						map.setCenter(lonLat,13);
						
						var click = new OpenLayers.Control.Click();
						map.addControl(click);
						click.activate();	
						textCounter(document.getElementById('nachricht'),document.getElementById('zeichen'),1024);
				    }
				//Set up a click handler
				OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {                
                defaultHandlerOptions: {
                    'single': true,
                    'double': false,
                    'pixelTolerance': 8,
                    'stopSingle': false,
                    'stopDouble': false
                }, initialize: function(options) {
                    this.handlerOptions = OpenLayers.Util.extend(
                        {}, this.defaultHandlerOptions
                    );
                    OpenLayers.Control.prototype.initialize.apply(
                        this, arguments
                    ); 
                    this.handler = new OpenLayers.Handler.Click(
                        this, {
                            'click': this.trigger
                        }, this.handlerOptions
                    );
                }, trigger: function(e) {
                    //A click happened!
                    var lonlat = map.getLonLatFromViewPortPx(e.xy)
                    lonlat.transform(
                      new OpenLayers.Projection("EPSG:900913"), 
                      new OpenLayers.Projection("EPSG:4326")
                    );
                    lati.innerHTML=lonlat.lat;
					longi.innerHTML=lonlat.lon;
					addressByCoords(lonlat.lat, lonlat.lon);
					lonLat = new OpenLayers.LonLat(lonlat.lon,lonlat.lat)
							.transform(
								new OpenLayers.Projection("EPSG:4326"), //transform from WGS 1984
								map.getProjectionObject() //to Spherical Mercator Projection
							);
						if (markers) {
							markers.destroy();
							markers = new OpenLayers.Layer.Markers( "Markers" );
						}
						markers.addMarker(new OpenLayers.Marker(lonLat));
						map.addLayer(markers);
						//aktivieren();
                }
            });
				
				function leeren(){
					document.getElementById("schadensort").value="";
				}
				
				function gpsCheck(){
					if(document.getElementById("schadensort").value==""){
						document.getElementById("gpsfail").removeAttribute("hidden");
					}
				}
				
				function init() {
					var mapnik = new OpenLayers.Layer.OSM();
					map.addLayer(mapnik);

					navigator.geolocation.getCurrentPosition(function(position) {
						lati.innerHTML=position.coords.latitude;
						longi.innerHTML=position.coords.longitude;
						addressByCoords(position.coords.latitude, position.coords.longitude);
						lonLat = new OpenLayers.LonLat(position.coords.longitude,position.coords.latitude)
							.transform(
								new OpenLayers.Projection("EPSG:4326"), //transform from WGS 1984
								map.getProjectionObject() //to Spherical Mercator Projection
							);
						if (markers) {
							markers.destroy();
							markers = new OpenLayers.Layer.Markers( "Markers" );
						}					
						markers.addMarker(new OpenLayers.Marker(lonLat));
						map.setCenter(lonLat, 16);
						map.addLayer(markers);
						//aktivieren();
						document.getElementById("gpsfail").setAttribute("hidden", true);
					});				
				}
				
				function coordsByAddress(){
					var geocoder = new google.maps.Geocoder();
					var address = document.getElementById('schadensort').value;
					  geocoder.geocode( { 'address': address}, function(results, status) {
						if (status == google.maps.GeocoderStatus.OK) {
						  lati.innerHTML = results[0].geometry.location.lat();
						  longi.innerHTML = results[0].geometry.location.lng();
						  addressByCoords(results[0].geometry.location.lat(),results[0].geometry.location.lng());
					lonLat = new OpenLayers.LonLat(results[0].geometry.location.lng(),results[0].geometry.location.lat())
							.transform(
								new OpenLayers.Projection("EPSG:4326"), //transform from WGS 1984
								map.getProjectionObject() //to Spherical Mercator Projection
							);
							map.setCenter(lonLat,16);
						if (markers) {
							markers.destroy();
							markers = new OpenLayers.Layer.Markers( "Markers" );
						}
						markers.addMarker(new OpenLayers.Marker(lonLat));
						map.addLayer(markers);
						//aktivieren();
					} else {
					  alert('Die Adresse konnte leider nicht gefunden werden.');
					}
				  });
				}
				
				function addressByCoords(eins, zwei) {
					var geocoder = new google.maps.Geocoder();
				    var latlng = new google.maps.LatLng(eins, zwei);
				    geocoder.geocode({'latLng': latlng}, function(results, status) {
					  if (results[0]) {
						var address = document.getElementById('schadensort');
						addressResult = results[0].formatted_address;					 
						if (addressResult.indexOf(" Dorsten, Deutschland")==-1){
							deaktivieren("nichtDorsten");
						} else{
							aktivieren();
						}
						if(addressResult.indexOf(", Deutschland")==-1){}else{
							addressResult = addressResult.replace(', Deutschland','');	
						}
						address.value = addressResult;
					  } 
					});
				}
				
				</script>
			</div>
		</div>
					<form id="my-awesome-dropzone" action="upload.php" class="dropzone">  
						<div class="dropzone-previews"></div>
						<div class="fallback"> <!--   this is the fallback if JS isn't working -->
						<input name="file" type="file" >
					</form>
					<script>
					  // myDropzone is the configuration for the element that has an id attribute
					  // with the value my-dropzone (or myDropzone)
					  Dropzone.options.myAwesomeDropzone = {
						init: function() {
						  this.on("addedfile", function(file) {

							// Create the remove button
							var removeButton = Dropzone.createElement("<button>Löschen</button>");


							// Capture the Dropzone instance as closure.
							var _this = this;

							// Listen to the click event
							removeButton.addEventListener("click", function(e) {
							  // Make sure the button click doesn't submit the form:
							  e.preventDefault();
							  e.stopPropagation();

							  // Remove the file preview.
							  _this.removeFile(file);
							  // If you want to the delete the file on the server as well,
							  // you can do the AJAX request here.
							});

							// Add the button to the file preview element.
							file.previewElement.appendChild(removeButton);
						  });
						}
					  };
					</script>
		</br>
	</div>
<h5 align="center">
	<b style="color: #8b8b8b">Version 0.61 | </b>
	<a href="http://www.dorsten.de/" id="link">
	<b style="color: #8b8b8b">www.dorsten.de</b></a>
	| <a href="impressum.html" id="link">
	<b style="color: #8b8b8b">Impressum</b>
	</a>
</h5>
</body>
</html>
